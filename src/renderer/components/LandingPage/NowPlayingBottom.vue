<template lang="pug">
  el-row.now-playing-bottom

    el-col(:span="4")
      el-container.center-container(style="align-items:center")
        img.image(:src="coverArt" height="38px" width="38px")
        el-container(direction="vertical").song-container
          h4.song-name {{songName}}
          h5.song-artist {{songArtist}}

          audio(:src="currentSongUri")#audio-player


    el-col(:span="20")
      el-row.seekbar-row
        vueSlideBar(v-model="seekbarProgress" :min="0" :max="totalTime" :showTooltip="false" style="padding-top: 0 !important" :processStyle="{ backgroundColor: '#fc5f45' }")

      el-row.media-controls
        el-col(:span="4")
          h5.time-text {{(playedTime/60).toFixed(2)}} / {{(totalTime/60).toFixed(2)}}

        el-col(:span="14" style="display:flex")
          el-col(:span="6").el-container.right-container
            el-button(icon="fas fa-random" plain circle).transparent-button
          el-col(:span="12").el-container.center-container
            el-button(icon="fas fa-step-backward" plain circle).transparent-button
            el-button(v-show="!isPaused" @click="playPause" icon="fas fa-pause-circle fa-3x" plain circle type="primary").transparent-button
            el-button(v-show="isPaused" @click="playPause" icon="fas fa-play-circle fa-3x" plain circle type="primary").transparent-button
            el-button(icon="fas fa-step-forward" plain circle).transparent-button
          el-col(:span="6").el-container.left-container
            el-button(@click="changeTrack('')" icon="fas fa-stop" plain circle).transparent-button

        el-col(:span="6" style="align-items: center").el-container.center-container
          el-button(icon="fas fa-volume-up" plain circle).transparent-button
          el-col(:span="24")
            vueSlideBar(v-model="volume" :min="0" :max="100" :showTooltip="false" style="padding-top: 0 !important" :processStyle="{ backgroundColor: '#fc5f45' }")


</template>

<script>
import VueSlideBar from 'vue-slide-bar';
import GlobalBus from './GlobalEventBus';

export default {
  components: { vueSlideBar: VueSlideBar },
  data() {
    return {
      coverArt: '',
      songName: '',
      songArtist: '',
      totalTime: 10,
      playedTime: 0,
      volume: 80,
      seekbarProgress: 10,
      currentSongUri: '',
      isPaused: false,
    };
  },
  mounted() {
    GlobalBus.$on('play-now', (song) => {
      this.changeTrack(song);
    });

    const audioPlayer = document.getElementById('audio-player');


    // Refresh UI every 100 ms
    setInterval(() => {
      // Seek
      if (this.seekbarProgress > (this.playedTime + 2) ||
        this.seekbarProgress < (this.playedTime - 2)) {
        audioPlayer.currentTime = this.seekbarProgress;
      }
      this.playedTime = Math.ceil(audioPlayer.currentTime);
      this.seekbarProgress = this.playedTime;
      this.isPaused = audioPlayer.paused;

      // Show Progress on Progress Bar
      // https://electronjs.org/docs/tutorial/progress-bar
      this.$electron.remote.BrowserWindow.getAllWindows()[0].setProgressBar(this.seekbarProgress);


      if (this.playedTime >= this.totalTime) {
        this.seekbarProgress = 0;
        GlobalBus.$emit('play-next-song');
      }
    }, 100);
  },

  methods: {
    updateVolume() {
      const audioPlayer = document.getElementById('audio-player');
      audioPlayer.volume = this.volume / 100;
    },

    playPause() {
      const audioPlayer = document.getElementById('audio-player');
      if (this.isPaused) {
        audioPlayer.play();
        this.isPaused = false;
      } else if (!this.isPaused) {
        audioPlayer.pause();
        this.isPaused = true;
      }
    },

    changeTrack(song) {
      const audioPlayer = document.getElementById('audio-player');
      audioPlayer.pause();
      this.currentSongUri = '';

      if (audioPlayer === null) return;

      if (typeof (song) === 'string' && song === '') {
        audioPlayer.pause();
        return;
      }

      audioPlayer.addEventListener('loadeddata', () => {
        if (audioPlayer.readyState >= 2) {
          audioPlayer.play();
        }
      });

      // Corrupted playing queue
      if (song.title === undefined) {
        GlobalBus.$emit('play-next-song');
        return;
      }
      this.songName = song.title;
      this.songArtist = song.artist;
      this.$uriCreator.generateDataUri(song.path, (content) => {
        this.currentSongUri = content;
      });
      this.totalTime = Math.round(song.duration);
      this.coverArt = song.coverArt;
    },
  },
  watch: {
    volume() {
      this.updateVolume();
    },
  },
};
</script>


<style lang="scss" scoped>
.now-playing-bottom {
  background-color: #1b1d1c;
  border: none;
  display: flex;
  align-items: center;
  height: 12vh;

  .transparent-button {
    font-size: 1rem;
  }
}

.seekbar-row {
  padding: 0;
}

.media-controls {
  display: flex;
  padding: 0rem 1rem;
}

.song-container {
  margin: 0 1rem;

  & > * {
    margin: 0.3rem 0;
  }

  .song-name {
    font-weight: 400;
    margin-bottom: 0;
  }

  .song-artist {
    font-weight: 200;
  }
}
</style>
